// Данные для экспонатов с локальными путями
const exhibitsData = [
    {
        id: 1,
        title: "НАКАНУНЕ ВОЙНЫ",
        description: "22 июня 1941 года… Еще накануне жизнь казалась безмятежной…советские люди спешили домой после рабочей недели, влюбленные пары прогуливались по зелёным аллеям, а в школах прозвенел последний звонок…  Никто тогда не знал, что всего одна дата может сломать миллионы жизней и судеб, разметать в клочья мечты и надежды.",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 2,
        title: "БРЕСТСКАЯ КРЕПОСТЬ",
        description: "Первыми удар вермахта приняли на себя советские пограничники. Навсегда в историю вписана оборона Брестской крепости. Приняв решение сопротивляться врагу, защитники Бреста героически обороняли крепость на протяжении месяца. Цитадель пала 23 июля.",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 3,
        title: "БИТВА ПОД МОСКВОЙ",
        description: "В октябре 1941 года немцы сосредоточили главные силы на московском направлении. Началось немецкое наступление на Москву. Московская битва завершилась Победой Советской армии и развеяла миф о непобедимости фашистских войск.",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 4,
        title: "ВАГОН-ГОСПИТАЛЬ",
        description: "В санитарных вагонах в годы войны не только перевозили раненых, но и оказывали необходимую медицинскую помощь. Бойцы называли врачей и медицинских сестер ангелами в белых халатах.",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 5,
        title: "КАЗАНЬ – ГОРОД ТРУДОВОЙ ДОБЛЕСТИ",
        description: "Республика Татарстан в годы войны стала одной из тыловых баз Красной Армии, её промышленность перестроилась на выпуск оборонной продукции, жители активно участвовали в помощи фронту, столица республики г. Казань превратилась в крупный госпитальный центр. С первых дней войны женщины и дети Татарии встали за станки оборонных предприятий. Благодаря своему подвигу, Казань носит звание города трудовой доблести.",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 6,
        title: "ТЫЛ ФРОНТУ!",
        description: "Не только силами фронта били в те дни врага. Героический подвиг совершили труженики тыла. В эти суровые годы задача по обеспечению фронта легла на хрупкие женские плечи. Круглосуточно в цехах трудились подростки, женщины, пожилые люди, чтобы снабдить фронт всем необходимым.",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 7,
        title: "БЛОКАДНЫЙ ЛЕНИНГРАД",
        description: "Одна из самых трагических страниц в истории 20 века – блокада Ленинграда. Ад для жителей начался 8 сентября 1941 года, когда гитлеровские войска замкнули кольцо вокруг города. 900 дней блокады стали символом ужаса и жестокости, но вместе с тем и героизма, непобедимости и стойкости советского народа…",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 8,
        title: "СТАЛИНГРАДСКАЯ БИТВА",
        description: "17 июля 1942 года началась Сталинградская битва. К началу октября гитлеровцы овладели большей частью Сталинграда. Но шел отчаянный бой не только за каждый дом, но и за каждый этаж. Символом беспримерного мужества защитников Сталинграда стал «дом Павлова».",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 9,
        title: "ОСВОБОЖДЕНИЕ ЕВРОПЫ",
        description: "В марте 1944 года Советские войска вышли на государственную границу СССР. Путь наших доблестных солдат к победе будет лежать через Европу. Шаг за шагом, город за городом, наша армия освободит народы Европы от гнёта фашизма.",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 10,
        title: "ПОБЕДА",
        description: "С 16 апреля велись ожесточенные бои за Берлин, и вот 30 апреля ровно в 21 час 50 минут над зданием Рейхстага взвилось красное советское знамя. 1418 дней войны были позади.",
        panorama: "panorams/exhibit1.jpg",
        audio: "audio/exhibit1.mp3",
        video: "videos/exhibit1.mp4",
        gallery: [
            "img/exhibit1/photo1.jpg",
            "img/exhibit1/photo2.jpg",
            "img/exhibit1/photo3.jpg"
        ]
    },
    {
        id: 11,
        title: "ПАМЯТЬ",
        description: "Победа подарила жизнь будущим поколениям, но была оплачена очень дорогой ценой. 27 миллионов советских граждан пожертвовали собой ради мира на земле и свободы народов.",
        panorama: "panorams/exhibit2.jpg",
        audio: "audio/exhibit2.mp3",
        video: "videos/exhibit2.mp4",
        gallery: [
            "img/exhibit2/photo1.jpg",
            "img/exhibit2/photo2.jpg"
        ]
    }
];

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function () {
    generateExhibits();
    initModals();
    initScrollAnimation();
});

// Генерация карточек экспонатов
function generateExhibits() {
    const container = document.getElementById('exhibits-container');

    exhibitsData.forEach(exhibit => {
        const card = document.createElement('div');
        card.className = 'exhibit-card';
        card.setAttribute('data-id', exhibit.id);

        card.innerHTML = `
            <div class="exhibit-img">${exhibit.title}</div>
            <div class="exhibit-content">
                <h3>${exhibit.title}</h3>
                <p>${exhibit.description}</p>
                <a href="#" class="read-more">Подробнее <i class="fas fa-arrow-right"></i></a>
            </div>
        `;

        // Добавляем оверлей из шаблона
        const overlayTemplate = document.getElementById('overlay-template');
        const overlay = overlayTemplate.content.cloneNode(true);
        overlay.querySelector('.overlay-title').textContent = exhibit.title;
        card.appendChild(overlay);

        container.appendChild(card);
    });

    initExhibitCards();
}

// Инициализация карточек экспонатов
function initExhibitCards() {
    const readMoreButtons = document.querySelectorAll('.read-more');
    const closeOverlayButtons = document.querySelectorAll('.close-overlay');
    const actionButtons = document.querySelectorAll('.action-btn');

    // Обработка кнопки "Подробнее"
    readMoreButtons.forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            const card = this.closest('.exhibit-card');
            const overlay = card.querySelector('.exhibit-overlay');

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
    });

    // Закрытие оверлея
    closeOverlayButtons.forEach(button => {
        button.addEventListener('click', function () {
            const overlay = this.closest('.exhibit-overlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        });
    });

    // Обработка кнопок действий
    actionButtons.forEach(button => {
        button.addEventListener('click', function () {
            const action = this.getAttribute('data-action');
            const card = this.closest('.exhibit-card');
            const exhibitId = parseInt(card.getAttribute('data-id'));
            const overlay = card.querySelector('.exhibit-overlay');

            overlay.classList.remove('active');

            // Находим данные экспоната
            const exhibit = exhibitsData.find(e => e.id === exhibitId);

            if (exhibit) {
                switch (action) {
                    case 'panorama':
                        openPanorama(exhibit);
                        break;
                    case 'audio':
                        openAudio(exhibit);
                        break;
                    case 'video':
                        openVideo(exhibit);
                        break;
                    case 'gallery':
                        openGallery(exhibit);
                        break;
                }
            }
        });
    });
}

// Инициализация модальных окон
function initModals() {
    // Закрытие модальных окон по клику на крестик
    const modalCloseButtons = document.querySelectorAll('.modal-close, .panorama-close');
    modalCloseButtons.forEach(button => {
        button.addEventListener('click', function () {
            const modal = this.closest('.modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';

            // Останавливаем видео при закрытии
            // В функции initModals добавьте:
            if (modal.id === 'video-modal') {
                const videoPlayer = document.getElementById('video-player');
                const video = videoPlayer.querySelector('video');
                if (video) {
                    video.pause();
                    video.currentTime = 0;
                }
                // Выход из полноэкранного режима
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            }

            // Останавливаем аудио при закрытии
            if (modal.id === 'audio-modal') {
                const audio = document.getElementById('audio-element');
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            }
        });
    });

    // Закрытие модальных окон по клику вне контента
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('click', function (e) {
            if (e.target === this) {
                this.classList.remove('active');
                document.body.style.overflow = '';

                // Останавливаем медиа при закрытии
                if (this.id === 'video-modal') {
                    const video = document.querySelector('#video-frame');
                    if (video) video.src = '';
                }
                if (this.id === 'audio-modal') {
                    const audio = document.getElementById('audio-element');
                    if (audio) audio.pause();
                }
            }
        });
    });
}

// Открытие панорамы
function openPanorama(exhibit) {
    const panoramaModal = document.getElementById('panorama-modal');
    const panoramaContainer = document.getElementById('panorama-container');

    // Показываем модальное окно
    panoramaModal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Очищаем контейнер
    panoramaContainer.innerHTML = '';

    // Проверяем, загружена ли библиотека Marzipano
    if (typeof Marzipano === 'undefined') {
        console.error('Marzipano library not loaded!');
        showPanoramaError(panoramaContainer, 'Библиотека панорам не загружена');
        return;
    }

    try {
        // Создаем панораму с помощью Marzipano
        const viewer = new Marzipano.Viewer(panoramaContainer, {
            controls: { mouseViewMode: 'drag' }
        });

        // Создаем источник изображения
        const source = Marzipano.ImageUrlSource.fromString(exhibit.panorama);

        // Создаем геометрию
        const geometry = new Marzipano.EquirectGeometry([{ width: 4000 }]);

        // Создаем ограничители для управления
        const limiter = Marzipano.RectilinearView.limit.traditional(4000, 100 * Math.PI / 180);
        const view = new Marzipano.RectilinearView(null, limiter);

        // Создаем сцену
        const scene = viewer.createScene({
            source: source,
            geometry: geometry,
            view: view,
            pinFirstLevel: true
        });

        // Переключаемся на сцену
        scene.switchTo();

    } catch (error) {
        console.error('Error creating panorama:', error);
        showPanoramaError(panoramaContainer, error.message);
    }
}

// Функция показа ошибки
function showPanoramaError(container, message) {
    container.innerHTML = `
        <div style="color: white; text-align: center; padding: 2rem; display: flex; flex-direction: column; justify-content: center; height: 100%;">
            <h3>Ошибка загрузки панорамы</h3>
            <p>${message}</p>
            <p>Попробуйте обновить страницу</p>
        </div>
    `;
}

// Открытие аудио гида
function openAudio(exhibit) {
    const audioModal = document.getElementById('audio-modal');
    const audioTitle = document.getElementById('audio-title');
    const audioDescription = document.getElementById('audio-description');
    const audioElement = document.getElementById('audio-element');

    // Заполняем данные
    audioTitle.textContent = exhibit.title;
    audioDescription.textContent = 'Аудиогид по экспозиции';
    audioElement.src = exhibit.audio;

    // Показываем модальное окно
    audioModal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Инициализируем аудио плеер
    initAudioPlayer();
}

// Инициализация аудио плеера
function initAudioPlayer() {
    const audio = document.getElementById('audio-element');
    const playPauseBtn = document.getElementById('play-pause');
    const progress = document.getElementById('audio-progress');
    const currentTimeEl = document.getElementById('current-time');
    const durationEl = document.getElementById('duration');

    // Обновление времени
    audio.addEventListener('loadedmetadata', function () {
        durationEl.textContent = formatTime(audio.duration);
    });

    audio.addEventListener('timeupdate', function () {
        const percent = (audio.currentTime / audio.duration) * 100;
        progress.style.width = percent + '%';
        currentTimeEl.textContent = formatTime(audio.currentTime);
    });

    // Кнопка воспроизведения/паузы
    playPauseBtn.addEventListener('click', function () {
        if (audio.paused) {
            audio.play();
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
            audio.pause();
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
    });

    // Перемотка по клику на прогресс-бар
    const progressContainer = document.querySelector('.progress-container');
    progressContainer.addEventListener('click', function (e) {
        const width = this.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        audio.currentTime = (clickX / width) * duration;
    });

    // Форматирование времени
    function formatTime(seconds) {
        let minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        seconds = seconds < 10 ? '0' + seconds : seconds;
        return minutes + ':' + seconds;
    }
}


// Открытие видео
// Открытие видео с кастомным плеером
function openVideo(exhibit) {
    const videoModal = document.getElementById('video-modal');
    const videoContainer = document.querySelector('.video-container');
    const videoPlayer = document.getElementById('video-player');
    const videoTitle = document.getElementById('video-title');
    const videoDescription = document.getElementById('video-description');

    // Заполняем данные
    videoTitle.textContent = exhibit.title;
    videoDescription.textContent = 'Видео экспозиции';

    // Очищаем видео плеер
    videoPlayer.innerHTML = '';
    
    // Создаем видео элемент
    const videoElement = document.createElement('video');
    videoElement.style.width = '100%';
    videoElement.style.height = 'auto';
    videoElement.style.display = 'block';

    const sourceElement = document.createElement('source');
    sourceElement.src = exhibit.video;
    sourceElement.type = 'video/mp4';

    videoElement.appendChild(sourceElement);
    videoElement.appendChild(document.createTextNode('Ваш браузер не поддерживает видео.'));

    videoPlayer.appendChild(videoElement);

    // Показываем модальное окно
    videoModal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Инициализируем кастомные контролы
    initCustomVideoPlayer(videoElement);
}

// Инициализация кастомного видео плеера
function initCustomVideoPlayer(videoElement) {
    const playPauseBtn = document.querySelector('.play-pause');
    const progressBar = document.querySelector('.progress');
    const progressContainer = document.querySelector('.progress-bar');
    const currentTimeEl = document.querySelector('.current-time');
    const durationEl = document.querySelector('.duration');
    const volumeBtn = document.querySelector('.volume-btn');
    const volumeSlider = document.querySelector('.volume-slider');
    const fullscreenBtn = document.querySelector('.fullscreen-btn');
    const videoPlayer = document.getElementById('video-player');

    let isDragging = false;

    // Обновление времени
    videoElement.addEventListener('loadedmetadata', function () {
        durationEl.textContent = formatTime(videoElement.duration);
    });

    videoElement.addEventListener('timeupdate', function () {
        if (!isDragging) {
            const percent = (videoElement.currentTime / videoElement.duration) * 100;
            progressBar.style.width = percent + '%';
            currentTimeEl.textContent = formatTime(videoElement.currentTime);
        }
    });

    // Кнопка воспроизведения/паузы
    playPauseBtn.addEventListener('click', function () {
        if (videoElement.paused) {
            videoElement.play();
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
            videoElement.pause();
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
    });

    // Перемотка по клику на прогресс-бар
    progressContainer.addEventListener('click', function (e) {
        const width = this.clientWidth;
        const clickX = e.offsetX;
        const duration = videoElement.duration;
        videoElement.currentTime = (clickX / width) * duration;
    });

    // Drag для прогресс-бара
    progressContainer.addEventListener('mousedown', function (e) {
        isDragging = true;
        updateProgress(e);
    });

    document.addEventListener('mousemove', function (e) {
        if (isDragging) {
            updateProgress(e);
        }
    });

    document.addEventListener('mouseup', function () {
        isDragging = false;
    });

    function updateProgress(e) {
        const width = progressContainer.clientWidth;
        const rect = progressContainer.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const percent = Math.max(0, Math.min(1, clickX / width));
        progressBar.style.width = percent * 100 + '%';
        videoElement.currentTime = percent * videoElement.duration;
        currentTimeEl.textContent = formatTime(videoElement.currentTime);
    }

    // Управление громкостью
    volumeBtn.addEventListener('click', function () {
        if (videoElement.volume > 0) {
            videoElement.volume = 0;
            volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            volumeSlider.value = 0;
        } else {
            videoElement.volume = 1;
            volumeBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            volumeSlider.value = 100;
        }
    });

    volumeSlider.addEventListener('input', function () {
        videoElement.volume = this.value / 100;
        volumeBtn.innerHTML = this.value > 0 ?
            '<i class="fas fa-volume-up"></i>' :
            '<i class="fas fa-volume-mute"></i>';
    });

    // Полноэкранный режим
    fullscreenBtn.addEventListener('click', function () {
        if (!document.fullscreenElement) {
            videoPlayer.requestFullscreen().catch(err => {
                console.log('Fullscreen error:', err);
            });
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
            document.exitFullscreen();
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        }
    });

    // Обработка окончания видео
    videoElement.addEventListener('ended', function () {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        videoElement.currentTime = 0;
    });

    // Форматирование времени
    function formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        let minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        seconds = seconds < 10 ? '0' + seconds : seconds;
        return minutes + ':' + seconds;
    }

    // Автовоспроизведение
    videoElement.play().then(() => {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
    }).catch(e => {
        console.log('Autoplay prevented:', e);
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    });
}

// Открытие фотогалереи
function openGallery(exhibit) {
    const galleryModal = document.getElementById('gallery-modal');
    const galleryContainer = document.getElementById('gallery-container');
    const galleryTitle = document.getElementById('gallery-title');

    // Заполняем данные
    galleryTitle.textContent = exhibit.title + ' - Фотогалерея';

    // Очищаем контейнер
    galleryContainer.innerHTML = '';

    // Добавляем фотографии
    exhibit.gallery.forEach((imgUrl, index) => {
        const galleryItem = document.createElement('div');
        galleryItem.className = 'gallery-item';
        galleryItem.innerHTML = `<img src="${imgUrl}" alt="Фото ${index + 1}">`;
        galleryContainer.appendChild(galleryItem);
    });

    // Показываем модальное окно
    galleryModal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// Анимация появления элементов при скролле
function initScrollAnimation() {
    const exhibitCards = document.querySelectorAll('.exhibit-card');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.classList.add('visible');
                }, 100 * Array.from(exhibitCards).indexOf(entry.target));
            }
        });
    }, { threshold: 0.1 });

    exhibitCards.forEach(card => {
        observer.observe(card);
    });
}